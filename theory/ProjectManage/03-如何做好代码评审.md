# 背景说明

-   代码评审
    -   code review
    -   通过**阅读代码**来检查源代码与编码**标准**的**符合性**以及**代码质量**的活动
-   代码评审非常重要
    -   在编写代码之外，**代码评审和单元测试**是两个最重要的工作
-   代码评审经常被忽视



# 一、常见误区

-   误区一：对**写代码**重视，对**评审代码**不重视
    -   代码评审**不算工作量**？
-   误区二：缺乏代码评审**工具**
    -   评审意见主要靠**口头**交流，无法**跟踪**修改情况
-   误区三：**无效**评审多
    -   评审**直接通过**
    -   评审**评论**很少
-   误区四：**人情**顾虑
    -   我把别人的代码打回，是不是影响我们之间的关系？

-   误区五：代码评审是浪费时间
    -   研发任务已经很紧张了





# 二、为什么要做代码评审

## 代码评审的重要意义

-   提升代码**质量**
    -   代码评审是提升代码质量 **最重要的** 方法
-   有助于知识传递
    -   代码评审是**辅导他人**编码最好方法



## 代码评审是提升代码质量的最好方法

![1689245592091](03-%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1.assets/1689245592091.png)



## 开发者希望老板理解代码评审的10件事（节选）

-   代码评审的目的是**改进代码质量**
  
-   **越早**发现问题，修复的成本就**越低**
  
-   高质量代码能够**节省成本**

    -   虽然短期花费时间，从长期来看是值得的

-   仅从**知识传递**，代码评审也值得做

    -   **每个人**都应该知道设计决策**背后的原因**

    >   很多团队某项工作基本由一个同学完全独立完成，没有备份，他所做的设计完全只有他自己知道，这样的工作方式风险非常大，一旦发生人员变动，整个项目都会因此受到影响。
    >
    >   一个软件项目需要做到：
    >
    >   -   知识传递（信息透明化）
    >   -   人员备份（控制项目风险）

    -   代码评审为开发者提供**解释设计**和**互相学习**的机会

-   代码评审是辅导他人编码最好的方法

    -   没有更好的方法

-   代码评审使团队对**顶级开发者**更有吸引力

    -   对**有经验**的软件工程师：没有代码评审习惯**非常恐怖**



## 为什么要提升代码质量

-   关于质量的误区
    -   代码只要能运行就可以了
    -   在交付时间紧张的情况下**可以牺牲**代码质量

-   质量第一
    -   无论如何定义质量，客户都不会容忍低质量的产品
    -   质量必须被放在首位，没有可商量的余地





## 代码质量差造成的问题

-   **时间都去哪里了？**
-   **重复编写**类似的逻辑
    -   缺少可复用的代码
-   定位**BUG**和修改BUG
-   **阅读**代码困难
    -   代码**可读性**差
-   踩坑 / 填坑
    -   挖坑容易，从坑里爬出来难
-   重构
    -   **推倒重来**，就肯定比前面的版本好？



## 为什么要提高编码能力

-   如果写了10年代码，编码能力没有提高，是什么后果？
    -   个人：职业危机
    -   团队：没有竞争力

-   出于生存的目的，也要提高编码能力





# 三、如何做好代码评审

## 代码评审中的常见问题

-   拼写错误
-   未优化的代码实现
-   不必要的复杂代码
-   **重复**实现已经存在的逻辑
-   缺少必要的**注释**
-   缺少必要的**单元测试**



## 在代码评审中应有的态度

-   对所评审代码完全看懂
    -   Yes：掌握情况就像自己写的一样
    -   No：对代码逻辑和背后的原因仍很模糊
-   不仅可以运行
    -   优秀代码的标准：**正确、可维护、可重用、可运维**
-   评审和编码**一样重要**
    -   评审也有产出：**更高质量**的代码
    -   评审比编码还要**更辛苦**：理解 & 找出问题
-   以**提升代码质量**为最终目的
    -   评审双方**共同**努力



## 代码评审的步骤

-   推荐方式：**自顶向下**，对代码进行**全面扫描**
-   Step 1：**系统全貌**
    -   **模块划分**的逻辑，**模块间**的关系
-   Step 2：**模块级别**
    -   看清**模块内**的逻辑
    -   关键**数据**、关键**类 / 函数** （重点：**功能、接口**定义）
-   Step 3：**类 / 函数**的**内部逻辑**
    -   **逻辑**正确性，**实现**合理性，**段落划分**合理性



## 关于坏代码的简单判断

-   **5分钟**内不能看懂的代码
    -   5分钟内无法看懂，大概率有问题
-   **需要思考**才能看懂的代码
    -   好的代码：**Don’t make me think**
-   需要**来回翻屏**才能看懂的代码
    -   好的代码：在**一屏**内就是**完整**的逻辑
-   没有 **空行 / 注释** 的代码
    -   不会用**段落**， 不会写**注释**，肯定不是好的程序员 



## 代码评审的注意事项

-   建立 owner 制度

    -   所有提交代码，必须由owner做最终确认
    -   很多问题来自于：**责任不明确**

-   综合多种**沟通**机制

    -   Yes：**面对面**的沟通；提供**设计文档**；提交代码**评审评论**

    >   1.  被评审者不仅仅需要提交代码，还需要提供设计文档
    >   2.  评审员对提交的代码进行评审，给出评审意见
    >   3.  被评审者针对评审意见对代码进行修复

    -   No：直接**大规模**评审会；仅**口头**沟通（无法追踪，只有被记录下来才可能被迭代优化）

    >   现场大规模评审会存在的问题：
    >
    >   1.  每个人对代码的理解不一样，查看的速度有快有慢，互相牵制，浪费时间
    >   2.  现场过程中很难加入批注，整个记录效率非常低
    >   3.  开完评审会没有追踪，看完评审会后就结束了

    >   口头沟通存在的问题：
    >
    >   1.  写下来的东西，理解起来可能还有偏差，更别说口头沟通了
    >   2.  口头沟通完全没有记录，无法追踪，无法进行回顾
    >   3.  在一个软件项目中，基本原则：信息透明化、一切都可以被追踪
    >   4.  只有数据被记录下来，它才有可能被迭代优化

-   **不放过**任何**一行**代码

    -   问题：只看大问题，不管**小问题**
    -   推荐：对评审中发现的问题，**一追到底**



## 代码评审的注意事项

-   控制节奏

    -   **小步快跑**：每次提交的代码量不要太多（最多几百行，减少复杂度）

        特殊情况：**新模块**构建，应逐步完成（通过多次提交）

    -   **每天**评审代码的数量**不宜过多**：每次最多1~1.5小时，在精力比较好的时段

-   为评审**预留**足够时间

    -   常见问题：只预留编码时间
    -   评审 ：编码 >= 1 : 1
    -   优化方法：把代码评审的时间**估算在内**





# 四、如何成为优秀的代码评审人

## 代码评审可以超越代码

-   好的QA，不仅可以发现系统中的bug
    -   还会质疑 / 提出 **产品需求**
    -   挑战 / 优化 **系统架构**和**实现方式**
-   好的代码评审人，不仅指出代码的问题，还会关注
    -   系统**需求分析**的质量
    -   **接口 / 函数**定义的合理性
    -   **模块划分**的合理性
    -   系统**关键机制**的合理性
-   作为评审人，你可以挑战**任何**事情！
    -   只要对**提高代码质量**是有帮助的



## 评审的质量，和评审人的能力直接相关

-   **业余**音乐**爱好者**，很难听出专业演出的**瑕疵**
-   专业的代码评审人，需要**专业**的素质
-   代码评审的质量，取决于**代码评审人的能力**





# 推荐书籍：

-   软件开发的201个原则
-   代码的艺术
-   代码大全2
-   代码整洁之道



# 总结：

1.  **代码评审**非常重要
    -   是提升代码质量和辅导编码的**最好方法**
2.  在代码评审中，要掌握**正确方法**
3.  提升代码评审质量，要提升**评审人的水平**